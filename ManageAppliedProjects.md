# Описание компоненты Manage Applied Projects

Компонента содержит набор команд, упрощающих ряд рутинных операций, с которыми сталкиваются прикладные разработчики в ходе разработки прикладных проектов на базе Directum RX.

Под прикладными проектами тут понимается набор, состоящий из БД, хранилища документов и одного или нескольких репозиториев исходного кода.

На данный момент компонента облегчает следующие задачи:

* быстрое переключение текущей инсталляции RX между разными прикладными проектами;
* создание нового прикладного проекта;
* формирование дистрибутивов прикладных решений, в т.ч. экспорт пакетов разработки;
* удаление старых файлов логов

## Установка компоненты

Для установки компоненты:

1. Скачайте из https://github.com/DirectumCompany/rx-manage-applied-projects/releases скачайте ManageAppProjects.zip

2. Перейдите в папку Directum Launcher и выполните команду

   ```
   do.bat components add_package <путь к файлу>\ManageAppProjects.zip
   ```


## Переключение между проектами

В практической работе прикладным разработчикам приходится работать с разными прикладными проектами. Или с разными ветками одного решения. Для этого можно использовать виртуальные машины, но это далеко не всегда удобно. В отличие от предыдущих версий RX, в RX 4.2, переключение между проектами стало гораздо проще. Тем не менее пока это еще не самая простая операция - нужно аккуратно изменить несколько параметров в config.yml и выполнить определенную последовательность команд используя do-скрипты DirectumLauncher - много места для человеческих ошибок.

Идея быстрого переключения между прикладными проектами заключается в том, чтобы для каждого проекта сделать простой файл описания проекта. В дальнейшем этот файл используется для автоматического изменения config.yml

Чтобы получить возможность переключения между проектами необходимо выполнить три шага:

1. Доработать стандартный config.yml
2. Создать файл описания текущего проекта
3. Переключиться на проекта

### Доработать стандартный config.yml

После установки RX штатными средствами, скорректируйте config.yml:

1. В группу variables добавить:

* переменную purpose, в которую будет записываться назначение проекта
* переменную database, в которую будет записываться имя базы данных проекта
* переменную home_path_src, в которую будет записываться корневой каталог для репозиториев проекта

2. в параметре common_config->CONNECTION_STRING использовать переменную database для задания базы данных
3. В параметре services_config->DevelopmentStudio->GIT_ROOT_DIRECTORY  использовать переменную home_path_src для задания корневого каталога репозиториев
4. "из коробки" каталог для логов сконфигурирован в домашний каталог проекта. Рекомендуется параметр logs_path -> LOGS_PATH скорректировать так, чтобы при переключении проектов логи писались всегда в одно место. Например, указать абсолютный путь.
5. "из коробки" сертификат для связи сервисов используется свой для каждого проекта - см. папку data_protection в домашнем каталоге проекта. Для упрощения переключения между проектами рекомендуется рекомендуется настроить так, чтобы у всех проектов использовался один сертификат. Для этого нужно перенести папку data_protection из домашнего каталога и изменить значение параметра common_config -> DATA_PROTECTION_CERTIFICATE_FILE.

В результате config.yml будет выглядеть примерно так:

```
# Переменные, которые можно использовать в этом же конфигурационном файле.
# Итоговый конфигурационный файл шаблонизируется при помощи Jinja2
variables:
    purpose: 'Чистая коробка RX 4.2.27'
    database: 'rx4227_newprj'
    home_path: 'd:\rx2\4227\d\newprj'
    home_path_src: 'd:\rx2\4227\s\'

    # Fully qualified domain name. По умолчанию вычисляется как DNS-имя текущей машины.
    # Для работы по ip можно задать значение '{{ host_ip }}'
    host_fqdn: 'localhost'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    http_port: 88
    https_port: 443
    protocol: 'http'

...

logs_path: &logs
    LOGS_PATH: 'C:\rx_logs\4.2'
common_config: &base
    ...
    CONNECTION_STRING: 'data source=W1192W10\SQLW1192W10;initial catalog={{ database }};user id=sa;Password=password'
    ...
    DATA_PROTECTION_CERTIFICATE_FILE: 'C:\rx_ver\data_protection\cert.pfx'
    DATA_PROTECTION_CERTIFICATE_FILE_PASSWORD: 'f4bc3790'
    ...
services_config:
    ...
    DevelopmentStudio:
        ...
        GIT_ROOT_DIRECTORY: '{{ home_path_src }}'
```

### Создать и настроить файл описания текущего проекта

Создать файл описания проекта можно командой `do map generate_empty_project_config`. В результате будет создан файл, в котором нужно заполнить конкретные значения. Которые следует взять из текущего config.yml.

````
# ключевые параметры проекта
variables:
    # Назначение проекта
    purpose: '<Назначение проекта>'
    # БД проекта
    database: '<База данных>'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: '<Домашний каталог>'
    # Корневой каталог c репозиториями проекта
    home_path_src: '<корневой каталог репозитория проекта>'
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository:
            -   '@folderName': '<папка репозитория-1>'
                '@solutionType': 'Work'
                '@url': '<url репозитория-1>'
            -   '@folderName': '<папка репозитория-2>'
                '@solutionType': 'Base'
                '@url': '<url репозитория-2>'
````

### Переключиться на проект

Переключиться на конкретный проект можно командой  `do map set <имя файла с описанием проекта>`. В результате будет скорректирован config.yml, обновлены конфиги сервисов и компонент и перезапущены сервисы RX.

### Пример организации каталогов для нескольких проектов

```
C:\rx                            <-------- корневой каталог для всех прикладных проектов
   +--4227                       <-------- корневой каталог для прикалдных проектов под RX 4.2.27
   |    +--d                     <-------- корневой каталог для домашних каталогов (хранилище документов)
   |    |  +-BoxOnly             |
   |    |  +-SampleSolution1     |  <---- каталоги конкретных проектов
   |    |  +-SampleSolution2     |
   |    |
   |    +--s                     <-------- корневой каталог для исходников проектов
   |       +-Box                 |
   |       +-BoxWork             |  <--------- каталоги репозиториев проектов
   |       +-SampleSolution1     |
   |       +-SampleSolution2     |
   |
   +--4325                      <-------- корневой каталог для прикалдных проектов под RX 4.3.25
   |    +--d
   |    |  +-BoxOnly
   |    +--s
   |       +-Box
   |       +-BoxWork
   |
   +--4227_BoxOnly.yml           |
   +--4227_SampleSolution1.yml   | <---------- Файлы описания проектов
   +--4227_SampleSolution2.yml   |
   +--4325_BoxOnly.yml           |
   
```

Файл описания проекта BoxOnly:

```
# ключевые параметры проекта
variables:
    purpose: 'Проект с чистой коробкой 4.2'
    # БД проекта
    database: 'rx4227_BoxOnly'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: 'C:\rx\4227\d\BoxOnly'
    # каталог c репозиториями проекта
    home_path_src: 'C:\rx\4227\s'
    # репозитории
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository: 
            -   '@folderName': 'BoxWork'
                '@solutionType': 'Work'
                '@url': ''
            -   '@folderName': 'Box'
                '@solutionType': 'Base'
                '@url': ''
```

Файл описания проекта SampleSolution1

```
# ключевые параметры проекта
variables:
    purpose: 'Пример решения-1 с автотестами для RX 4.2'
    # БД проекта
    database: 'rx4227_SampleSolution1'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: 'C:\rx\4227\d\SampleSolution1'
    # каталог c репозиториями проекта
    home_path_src: 'C:\rx\4227\s'
    # репозитории
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository: 
            -   '@folderName': 'SampleSolution1'
                '@solutionType': 'Work'
                '@url': ''
            -   '@folderName': 'Box'
                '@solutionType': 'Base'
                '@url': ''
```

Файл описания проекта SampleSolution1

```
# ключевые параметры проекта
variables:
    purpose: 'Пример решения с автотестами для RX 4.2'
    # БД проекта
    database: 'rx4227_SampleSolution2'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: 'C:\rx\4227\d\SampleSolution2'
    # каталог c репозиториями проекта
    home_path_src: 'C:\rx\4227\s'
    # репозитории
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository: 
            -   '@folderName': 'SampleSolution2'
                '@solutionType': 'Work'
                '@url': ''
            -   '@folderName': 'Box'
                '@solutionType': 'Base'
                '@url': ''
```

### Рекомендации по использованию переключения между проектами

Посмотреть на какой проект сейчас настроен текущий instance RX можно командой `do map current` - в консоли отобразится ключевая информация из config.yml.

Посмотреть содержимое какого-либо файла описания проекта можно командой `do map check_config` - в консоли отобразится ключевая информация из указанного файла описания проекта.

## Создание нового прикладного проекта

Бывают ситуации, когда нужно быстро поднять основу для нового прикладного проекта. Сейчас это сделать просто:

1. Подготовить файл описания проекта
2. Выполнить команду `do map create_project <файл-описания-проекта>`

В результате выполнения:

* создана новая БД
* будет создан новый домашний каталог проекта каталог  
* в БД будет принята прикладная разработка из указанного пакета разработки и выполнена инициализация
* импортированы стандартные шаблоны

При необходимости можно также импортировать исходные коды из того же пакета разработки.

## Формирование дистрибутивов решений

## Прочее

### Удаление старых файлов логов

По умолчанию RX настроен так, что каждый день компоненты и сервисы RX создают новые файлы логов. На рабочем месте прикладного разработчика, как правило, важны текущие логи, а старые не имеют особого значения. Для удаления логов можно использовать команду `do map clear_log`. Если ну указывать дополнительные параметры, то будут удалены логи сервисов и компонент текущего инстанса старее 3-х дней.