# Описание компоненты Manage Applied Projects

Компонента содержит набор команд, упрощающих ряд рутинных операций, с которыми сталкиваются прикладные разработчики в ходе разработки прикладных проектов на базе Directum RX.

Под прикладными проектами тут понимается набор, состоящий из БД, хранилища документов и одного или нескольких репозиториев исходного кода.

На данный момент компонента облегчает следующие задачи:

* управление прикладными проектами: создание, копирование, переключение между прикладными проектами;
* формирование дистрибутивов прикладных решений, в т.ч. экспорт пакетов разработки;
* удаление старых файлов логов

Внимание! Компонента рассчитана на применение на рабочих местах разработчиков и не предназначены для управления продуктивными серверами.

## Установка компоненты

1. Скачайте ManageAppProjects.zip из https://github.com/DirectumCompany/rx-manage-applied-projects/releases.

2. Перейдите в папку Directum Launcher и выполните команду:

   ```
   do.bat components add_package <путь к файлу>\ManageAppProjects.zip
   ```

Чтобы обновить компоненту, установленную таким способом, её нужно будет сначала удалить:

```
do.bat components delete map
```

## Управление прикладными проектами

В практической работе прикладным разработчикам приходится работать с разными прикладными проектами. Например, проекты для разработки разных решений или разные ветки одного решения. Для этого можно использовать виртуальные машины, но это далеко не всегда удобно:

* для более-менее комфортной работы требуется выделять существенные аппаратные ресурсы;
* каждую виртуалку нужно настраивать под себя.

Чтобы переключить на другой проект RX до версии 4.1 включительно необходимо было изменить параметры подключения к БД во многих конфиг-файлах. В Directum RX 4.2, переключение между проектами стало проще - достаточно поменять несколько параметров в config.yml и выполнить несколько определенную последовательность команд используя do-скрипты DirectumLauncher. Однако и этот способ неудобен, когда переключаться надо между несколькими проектами - оставляет достаточно места для человеческих ошибок. Например, можно легко ошибиться и изменить БД, но забыть изменить список репозиториев. В результате БД может быть испорчена.

Кроме этого в практической работы встречаются такие ситуации:

* сделать копию текущего проекта, например, чтобы безопасно проверить изменения в ветке. Ранее нужно было вручную делать копию БД, копировать каталог с хранилищем документов.
* необходимо создать новый проект, например чтобы начать работу над новым решением. Ранее приходилось заранее сохранить копию БД и хранилища "чистой" системы.

Идея быстрого переключения между прикладными проектами заключается в том, чтобы для каждого проекта сделать простой файл описания проекта. В дальнейшем эти файлы используется для автоматического изменения config.yml при переключении между проектами.

### Подготовка к использованию компоненты управления прикладными проектами

Чтобы получить возможность переключения между проектами необходимо:

1. Доработать стандартный config.yml
2. Создать файл описания текущего проекта

#### Доработать стандартный config.yml

После установки RX штатными средствами, скорректируйте config.yml:

1. В группу variables добавить:

* переменную purpose, в которую будет записываться назначение проекта
* переменную database, в которую будет записываться имя базы данных проекта
* переменную home_path_src, в которую будет записываться корневой каталог для репозиториев проекта

2. в параметре common_config->CONNECTION_STRING использовать переменную database для задания базы данных
3. В параметре services_config->DevelopmentStudio->GIT_ROOT_DIRECTORY  использовать переменную home_path_src для задания корневого каталога репозиториев
4. "из коробки" каталог для логов сконфигурирован в домашний каталог проекта. Рекомендуется параметр logs_path -> LOGS_PATH скорректировать так, чтобы при переключении проектов логи писались всегда в одно место. Например, указать абсолютный путь.
5. "из коробки" сертификат для связи сервисов используется свой для каждого проекта - см. папку data_protection в домашнем каталоге проекта. Для упрощения переключения между проектами рекомендуется рекомендуется настроить так, чтобы у всех проектов использовался один сертификат. Для этого нужно перенести папку data_protection из домашнего каталога и изменить значение параметра common_config -> DATA_PROTECTION_CERTIFICATE_FILE.

В результате config.yml будет выглядеть примерно так:

```
# Переменные, которые можно использовать в этом же конфигурационном файле.
# Итоговый конфигурационный файл шаблонизируется при помощи Jinja2
variables:
    purpose: 'Чистая коробка RX 4.2.27'
    database: 'rx4227_newprj'
    home_path: 'd:\rx2\4227\d\newprj'
    home_path_src: 'd:\rx2\4227\s\'

    # Fully qualified domain name. По умолчанию вычисляется как DNS-имя текущей машины.
    # Для работы по ip можно задать значение '{{ host_ip }}'
    host_fqdn: 'localhost'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    http_port: 88
    https_port: 443
    protocol: 'http'

...

logs_path: &logs
    LOGS_PATH: 'C:\rx_logs\4.2'
common_config: &base
    ...
    CONNECTION_STRING: 'data source=W1192W10\SQLW1192W10;initial catalog={{ database }};user id=sa;Password=password'
    ...
    DATA_PROTECTION_CERTIFICATE_FILE: 'C:\rx_ver\data_protection\cert.pfx'
    DATA_PROTECTION_CERTIFICATE_FILE_PASSWORD: 'f4bc3790'
    ...
services_config:
    ...
    DevelopmentStudio:
        ...
        GIT_ROOT_DIRECTORY: '{{ home_path_src }}'
```

#### Создать и настроить файл описания текущего проекта

Создать файл описания проекта можно командой `do map generate_empty_project_config`. В результате будет создан файл, в котором нужно заполнить конкретные значения. Которые следует взять из текущего config.yml.

````
# ключевые параметры проекта
variables:
    # Назначение проекта
    purpose: '<Назначение проекта>'
    # БД проекта
    database: '<База данных>'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: '<Домашний каталог>'
    # Корневой каталог c репозиториями проекта
    home_path_src: '<корневой каталог репозитория проекта>'
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository:
            -   '@folderName': '<папка репозитория-1>'
                '@solutionType': 'Work'
                '@url': '<url репозитория-1>'
            -   '@folderName': '<папка репозитория-2>'
                '@solutionType': 'Base'
                '@url': '<url репозитория-2>'
````

#### Переключиться на проект

Переключиться на конкретный проект можно командой  `do map set <имя файла с описанием проекта>`. В результате будет скорректирован config.yml, обновлены конфиги сервисов и компонент и перезапущены сервисы RX.

### Создание нового прикладного проекта

Чтобы создать новый прикладной проект необходимо:

1. Подготовить файл описания проекта
2. Выполнить команду `do map create_project <файл-описания-проекта>`

В результате выполнения:

* будет создана новая БД
* будет создан новый домашний каталог проекта
* в БД будет принята прикладная разработка из указанного пакета разработки и выполнена инициализация
* импортированы стандартные шаблоны

Если добавить параметр `--need_import_src`, то сразу будут импортированы исходные коды из того же пакета разработки.

### Клонирование прикладного проекта

В некоторых случаях создать новый проект удобнее копирование существующего. Например, чтобы безопасно проверить изменения в ветке проекта.

Чтобы сделать копию проекта необходимо:

1. Подготовить файл описания проекта
2. Выполнить команду `do map clone_project <файл-описания-проекта-источника>  <файл-описания-проекта-назначения>`

В результате выполнения:

* будет создана  копия БД
* будет создана копия домашнего каталога проекта

Особенности работы:

* при использовании Microsoft SQL Server:
  * создается полная копия исходной БД с режимом COPY_ONLY, чтобы не нарушать политику резервного копирования
  * копия БД создается в том же каталоге, где расположена сама БД и удаляется после восстановления из неё копии БД
* при использовании PostgreSQL:
  * копия БД парой выполняется парой утилит `pg_dump | psql` и для корректной работы требует настройки [файла паролей](https://postgrespro.ru/docs/postgrespro/9.5/libpq-pgpass) pgpass.conf

### Рекомендации по использованию переключения между проектами

Посмотреть на какой проект сейчас настроен текущий instance RX можно командой `do map current` - в консоли отобразится ключевая информация из config.yml.

Посмотреть содержимое какого-либо файла описания проекта можно командой `do map check_config` - в консоли отобразится ключевая информация из указанного файла описания проекта.

#### Пример организации каталогов для нескольких проектов

Вариант организации домашних каталогов, каталогов с исходниками и конфигов с описанием проектов представлен ниже. 

```
C:\rx                            <-------- корневой каталог для всех прикладных проектов
   +--4227                       <-------- корневой каталог для прикалдных проектов под RX 4.2.27
   |    +--d                     <-------- корневой каталог для домашних каталогов (хранилище документов)
   |    |  +-BoxOnly             |
   |    |  +-SampleSolution1     |  <---- каталоги конкретных проектов
   |    |  +-SampleSolution2     |
   |    |
   |    +--s                     <-------- корневой каталог для исходников проектов
   |       +-Box                 |
   |       +-BoxWork             |  <--------- каталоги репозиториев проектов
   |       +-SampleSolution1     |
   |       +-SampleSolution2     |
   |
   +--4325                      <-------- корневой каталог для прикалдных проектов под RX 4.3.25
   |    +--d
   |    |  +-BoxOnly
   |    +--s
   |       +-Box
   |       +-BoxWork
   |
   +--4227_BoxOnly.yml           |
   +--4227_SampleSolution1.yml   | <---------- Файлы описания проектов
   +--4227_SampleSolution2.yml   |
   +--4325_BoxOnly.yml           |
   
```

Файл описания проекта BoxOnly:

```
# ключевые параметры проекта
variables:
    purpose: 'Проект с чистой коробкой 4.2'
    # БД проекта
    database: 'rx4227_BoxOnly'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: 'C:\rx\4227\d\BoxOnly'
    # каталог c репозиториями проекта
    home_path_src: 'C:\rx\4227\s'
    # репозитории
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository: 
            -   '@folderName': 'BoxWork'
                '@solutionType': 'Work'
                '@url': ''
            -   '@folderName': 'Box'
                '@solutionType': 'Base'
                '@url': ''
```

Файл описания проекта SampleSolution1

```
# ключевые параметры проекта
variables:
    purpose: 'Пример решения-1 с автотестами для RX 4.2'
    # БД проекта
    database: 'rx4227_SampleSolution1'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: 'C:\rx\4227\d\SampleSolution1'
    # каталог c репозиториями проекта
    home_path_src: 'C:\rx\4227\s'
    # репозитории
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository: 
            -   '@folderName': 'SampleSolution1'
                '@solutionType': 'Work'
                '@url': ''
            -   '@folderName': 'Box'
                '@solutionType': 'Base'
                '@url': ''
```

Файл описания проекта SampleSolution1

```
# ключевые параметры проекта
variables:
    purpose: 'Пример решения с автотестами для RX 4.2'
    # БД проекта
    database: 'rx4227_SampleSolution2'
    # Домашняя директория, относительно которой хранятся все данные сервисов.
    # Используется только в конфигурационном файле.
    home_path: 'C:\rx\4227\d\SampleSolution2'
    # каталог c репозиториями проекта
    home_path_src: 'C:\rx\4227\s'
    # репозитории
# репозитории
services_config:
    DevelopmentStudio:
        REPOSITORIES:
            repository: 
            -   '@folderName': 'SampleSolution2'
                '@solutionType': 'Work'
                '@url': ''
            -   '@folderName': 'Box'
                '@solutionType': 'Base'
                '@url': ''
```

## Формирование дистрибутивов решений

## Прочее

### Удаление старых файлов логов

По умолчанию RX настроен так, что каждый день компоненты и сервисы RX создают новые файлы логов. На рабочем месте прикладного разработчика, как правило, важны текущие логи, а старые не имеют особого значения. Для удаления логов можно использовать команду `do map clear_log`. Если ну указывать дополнительные параметры, то будут удалены логи сервисов и компонент текущего инстанса старее 3-х дней.